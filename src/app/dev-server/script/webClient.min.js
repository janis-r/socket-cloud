var webClient=function(e){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var r=function(){return(r=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var i in r=arguments[t])Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i]);return e}).apply(this,arguments)};function t(e){var r="function"==typeof Symbol&&e[Symbol.iterator],t=0;return r?r.call(e):{next:function(){return e&&t>=e.length&&(e=void 0),{value:e&&e[t++],done:!e}}}}function n(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,i,a=t.call(e),o=[];try{for(;(void 0===r||r-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(t=a.return)&&t.call(a)}finally{if(i)throw i.error}}return o}var i=function(){function e(){var e=this;this.callbacks=new Map,this.add=function(r){var t=e.callbacks;if(t.has(r))return{success:!1};var n={};t.set(r,n);var i=function(e){return n.onComplete=e},a=function(e){return n.executionLimit=e,{onComplete:i}},o=function(){return a(1)},s=function(){return a(2)};return{success:!0,guard:function(e){return n.guard=e,{once:o,twice:s,times:a}},once:o,twice:s,times:a}},this.has=function(r){return e.callbacks.has(r)},this.remove=function(r){var t=e.callbacks;return!!t.has(r)&&(t.delete(r),!0)},this.clear=function(){return e.callbacks.clear()},this.execute=function(r){var i,a,o=e.callbacks,s=0;try{for(var l=t(o),c=l.next();!c.done;c=l.next()){var u=n(c.value,2),f=u[0],h=u[1];h.guard&&!h.guard(r)||(f(r),s++,h.executionLimit&&(h.executionCount?h.executionCount++:h.executionCount=1,h.executionCount===h.executionLimit&&(h.onComplete&&h.onComplete(),o.delete(f))))}}catch(e){i={error:e}}finally{try{c&&!c.done&&(a=l.return)&&a.call(l)}finally{if(i)throw i.error}}return s},this.manage=this.manage.bind(this)}return e.prototype.manage=function(e){if(e)return this.add(e);return{has:this.has,remove:this.remove,clear:this.clear}},e}(),a=function(){function e(e){var r=this;this.onOpenCallback=new i,this.onMessageCallback=new i,this.onErrorCallback=new i,this.onCloseCallback=new i,this.onOpen=this.onOpenCallback.manage,this.onMessage=this.onMessageCallback.manage,this.onError=this.onErrorCallback.manage,this.onClose=this.onCloseCallback.manage,this.socket=new WebSocket(e),this.socket.onopen=function(){return r.onOpenCallback.execute()},this.socket.onmessage=function(e){var t=e.data;return r.onMessageCallback.execute(t)},this.socket.onerror=function(e){return r.onErrorCallback.execute(e.toString())},this.socket.onclose=function(e){var t=e.code,n=e.reason;return r.onCloseCallback.execute({code:t,reason:n})}}return Object.defineProperty(e.prototype,"state",{get:function(){return this.socket.readyState},enumerable:!0,configurable:!0}),e.prototype.send=function(e){this.socket.send(e)},e.prototype.close=function(e,r){this.socket.close(e,r)},e}();function o(e,r){return null!==function(e,r){const t=Object.keys(e);for(const n of t)if(e.hasOwnProperty(n)&&e[n]===r)return n;return null}(e,r)}function s(e){const r=[];for(const t of e)-1===r.indexOf(t)&&r.push(t);return r}var l;!function(e){e[e.Add=0]="Add",e[e.Remove=1]="Remove",e[e.Clear=2]="Clear",e[e.Commit=3]="Commit"}(l||(l={}));var c,u;!function(e){e.Date="date",e.Month="month",e.Year="year",e.Hours="hours",e.Minutes="minutes",e.Seconds="seconds",e.Epoch="epoch"}(c||(c={})),function(e){e[e.Subscribe=0]="Subscribe",e[e.Unsubscribe=1]="Unsubscribe",e[e.PushToServer=2]="PushToServer",e[e.PushToClient=3]="PushToClient",e[e.RestoreRequest=4]="RestoreRequest",e[e.RestoreResponse=5]="RestoreResponse"}(u||(u={}));var f=function(e){return Array.isArray(e)&&!e.some((function(e){return"string"!=typeof e}))};function h(e,r,t,n){if("array"===r){if(!Array.isArray(e))return{error:"Type mismatch. Type is expected to be an array"};if(t&&!e.length)return{error:"Array is empty."};if(n&&e.some((function(e){return!n(e)})))return{error:"Array item type mismatch."}}else if("string[]"===r){if(!f(e))return{error:"Type mismatch. Type is expected to be an array of strings"};if(t&&!e.length)return{error:"Array length mismatch - is empty."};if(n&&e.some((function(e){return!n(e)})))return{error:"Array item type mismatch."}}else{var i=typeof e;if(r!==i)return{error:"Type mismatch. Expected: "+r+", actual: "+i};if(t&&"string"==typeof e&&!e.length)return{error:"String length mismatch - is empty."}}return!0}var d=function(){function e(e){var n=this;this.config=e,this.validate=function(e){var i=function(e,n,i){var a,o;if(void 0===i&&(i=!1),"object"!=typeof e)return{error:"Value is not an object: "+e};var l=Object.keys(e),c=function(t){var n=t.field,i=t.optional,a=t.exactValue,o=t.type,c=t.validator,u=t.notEmpty,d=t.itemValidator,p=n,y=l.indexOf(p);if(-1===y)return i?"continue":{value:{field:p,error:"Field is missing"}};var m=e[p];if("exactValue"in t&&m!==a)return{value:{field:p,error:"Exact value mismatch. Expected: "+a+", actual: "+m}};if(o)if(f(o)){var g=s(o);if(!g.some((function(e){return!0===h(m,e,u,d)})))return{value:{field:p,error:"Type mismatch. Value didn't match any of ["+g+"] types allowed"}}}else{var v=h(m,o,u,d);if(!0!==v)return{value:r({field:p},v)}}if(c&&!c(m,p))return{value:{field:p,error:"Value "+m+" disallowed by validator"}};l.splice(y,1)};try{for(var u=t(n),d=u.next();!d.done;d=u.next()){var p=c(d.value);if("object"==typeof p)return p.value}}catch(e){a={error:e}}finally{try{d&&!d.done&&(o=u.return)&&o.call(u)}finally{if(a)throw a.error}}return!(l.length>0&&!i)||{error:"Extra, disallowed fields ["+l+"] encountered"}}(e,n.config);return n._lastValidationError=!0===i?null:i,!0===i},this.serialize=function(e){var r=n,t=r.validate,i=r.allFields,a=r.fieldSerializers;return t(e)?JSON.stringify(i.map((function(r){if(a.has(r)){var t=a.get(r),i=n.configMap.get(r).type;return"array"===i||"string[]"===i?e[r].map(t):t(e[r])}return e[r]}))):null},this.deserialize=function(e){var r,t=n,i=t.allFields,a=t.fieldDeserializers,o=t.configMap;if("string"==typeof e)try{r=JSON.parse(e)}catch(r){return console.log("Error while deserialize",{value:e,e:r}),null}else r=e;if(!Array.isArray(r)||r.length!=i.length)return console.log("Error while deserialize - not enough fields",e),null;var l={};return i.forEach((function(e){var t,i=r.shift();if(a.has(e)){var c=a.get(e),u=n.configMap.get(e).type;t="array"===u||"string[]"===u?i.map(c):c(i)}else t=i;Array.isArray(t)&&o.get(e).unique?l[e]=s(t):null===t&&o.get(e).optional||(l[e]=t)})),n.validate(l)?l:(console.log("Error while deserialize - validation has failed",{value:e,parsed:l}),null)};var i=[],a=[],o=new Map,l=new Map,c=new Map;e.map((function(e){var r=e.field,t=e.optional;return o.set(r,e),e.itemSerializer&&l.set(r,e.itemSerializer),e.itemDeserializer&&c.set(r,e.itemDeserializer),{field:r,optional:t}})).forEach((function(e){var r=e.field,t=e.optional;i.push(r),t&&a.push(r)})),this.allFields=i,this.requiredFields=a,this.configMap=o,this.fieldSerializers=l,this.fieldDeserializers=c}return Object.defineProperty(e.prototype,"lastValidationError",{get:function(){return this._lastValidationError},enumerable:!0,configurable:!0}),e}(),p=new d([{field:"type",exactValue:u.PushToClient},{field:"time",type:"number"},{field:"messageId",type:"string"},{field:"payload",type:"string"},{field:"channels",type:"string[]",optional:!0}]),y=new d([{field:"time",type:"number"},{field:"messageId",type:"string"},{field:"channels",type:"string[]"},{field:"payload",type:"string"}]),m=new d([{field:"type",exactValue:u.RestoreResponse},{field:"payload",type:"array",itemValidator:y.validate,itemSerializer:y.serialize,itemDeserializer:y.deserialize}]),g=new d([{field:"type",exactValue:u.Subscribe},{field:"channels",type:"string[]",unique:!0}]),v=new d([{field:"type",exactValue:u.Unsubscribe},{field:"channels",type:"string[]"}]),b=new d([{field:"maxAge",type:"number",optional:!0,itemValidator:function(e){return e>0}},{field:"maxLength",type:"number",optional:!0,itemValidator:function(e){return e>0}},{field:"messageId",type:"string",optional:!0,notEmpty:!0}]),C=new d([{field:"channel",type:"string"},{field:"filter",optional:!0,type:"object",itemValidator:b.validate,itemSerializer:b.serialize,itemDeserializer:b.deserialize}]),w=new d([{field:"type",exactValue:u.RestoreRequest},{field:"channels",type:"array",itemValidator:function(e){return C.validate(e)}}]),k=new d([{field:"type",exactValue:u.PushToServer},{field:"channels",type:"string[]",unique:!0},{field:"payload",type:"string"}]),x=function(){function e(e){var r=this;this.connection=e,this.onMessageCallback=new i,this.onRestoreCallback=new i,this.errorHandler=function(e){console.error("Connection error:",e)},this.messageHandler=function(e){var t=r,n=t.onMessageCallback,i=t.onRestoreCallback,a=function(e){var r;try{r=JSON.parse(e)}catch(r){return console.log("Error while deserialize ServerMessage",{value:e,e:r}),null}if(!Array.isArray(r)||!r.length||!o(u,r[0]))return console.log("Error while deserialize ServerMessage 2 ",r),null;var t=r[0];return t===u.PushToClient?p.deserialize(r):t===u.RestoreResponse?m.deserialize(r):null}(e);switch(a.type){case u.PushToClient:n.execute(a);break;case u.RestoreResponse:i.execute(a);break;default:console.error("Message of unknown type received:",a)}},this.onMessage=this.onMessageCallback.manage,this.onRestore=this.onRestoreCallback.manage,e.onError(this.errorHandler),e.onMessage(this.messageHandler)}return e.prototype.subscribe=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.connection.send(g.serialize({type:u.Subscribe,channels:e}))},e.prototype.unsubscribe=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.connection.send(v.serialize({type:u.Unsubscribe,channels:e}))},e.prototype.restore=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.connection.send(w.serialize({type:u.RestoreRequest,channels:e}))},e.prototype.sendGlobalMessage=function(e){this.sendChannelMessage(e,"/")},e.prototype.sendChannelMessage=function(e){for(var r=[],t=1;t<arguments.length;t++)r[t-1]=arguments[t];this.connection.send(k.serialize({type:u.PushToServer,channels:r,payload:e}))},e.prototype.close=function(){this.connection.close()},e}();["connection","onMessageCallback","onRestoreCallback","errorHandler","messageHandler"].forEach((function(e){return Object.defineProperty(x,e,{enumerable:!1,writable:!1})}));return e.createClient=function(e){return new x(new a(e))},e.version="1.0.0",e}({});
//# sourceMappingURL=webClient.min.js.map
